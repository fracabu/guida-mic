<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulazione Esame MIC 1800 - Assistenti Amministrativi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #f1f5f9;
            --bg-card: white;
            --bg-option: white;
            --bg-option-hover: #f8fafc;
            --bg-option-selected: #eef2ff;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --accent-color: #4f46e5;
            --accent-light: #e0e7ff;
            --shadow-color: rgba(0,0,0,0.08);
            --correct-bg: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            --correct-border: #10b981;
            --correct-text: #065f46;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-card: #1e293b;
            --bg-option: #1e293b;
            --bg-option-hover: #334155;
            --bg-option-selected: #3730a3;
            --text-primary: #f1f5f9;
            --text-secondary: #e2e8f0;
            --text-muted: #94a3b8;
            --border-color: #334155;
            --accent-color: #818cf8;
            --accent-light: #312e81;
            --shadow-color: rgba(0,0,0,0.3);
            --correct-bg: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
            --correct-border: #10b981;
            --correct-text: #a7f3d0;
        }

        html, body {
            height: 100%;
            overflow-x: hidden;
        }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-primary);
            transition: background 0.3s, color 0.3s;
        }

        /* CONTAINER */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .container.start-mode {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px 30px;
        }
        .container.exam-mode {
            max-width: 1200px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 20px;
            overflow: hidden;
        }
        .container.exam-mode .header-exam {
            display: none;
        }

        /* HEADER */
        .header-exam {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 16px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(79, 70, 229, 0.35);
            position: relative;
        }
        .header-exam h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }
        .header-exam h2 {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255,255,255,0.9);
        }

        /* HEADER BUTTONS */
        .header-buttons {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 8px;
        }
        .pdf-btn, .back-btn {
            padding: 8px 14px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        .pdf-btn:hover, .back-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        /* THEME TOGGLE */
        .theme-toggle {
            position: absolute;
            top: 15px;
            left: 15px;
            padding: 8px 14px;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.25);
        }

        /* TIMER E STATS BAR */
        .stats-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 15px;
            z-index: 100;
            flex-shrink: 0;
        }
        .stat-box {
            flex: 1;
            min-width: 120px;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-box.timer {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: white;
        }
        .stat-box.timer.warning {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-box.timer .stat-label {
            color: rgba(255,255,255,0.8);
        }
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .stat-box.timer .stat-value {
            color: white;
            font-family: 'Courier New', monospace;
        }

        /* PROGRESS BAR */
        .progress-container {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 12px 18px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px var(--shadow-color);
            flex-shrink: 0;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #818cf8);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        /* INSTRUCTIONS */
        .instructions {
            background: var(--accent-light);
            border-left: 4px solid var(--accent-color);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 12px;
            text-align: left;
        }
        .instructions h3 {
            color: var(--accent-color);
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        .instructions ul {
            margin-left: 18px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        .instructions li {
            margin-bottom: 4px;
            line-height: 1.4;
        }
        .instructions .highlight {
            background: var(--border-color);
            color: var(--text-primary);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        /* EXAM LAYOUT - TWO COLUMNS */
        .exam-layout {
            flex: 1;
            display: flex;
            gap: 20px;
            min-height: 0;
            overflow: hidden;
        }
        .exam-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        .exam-sidebar {
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }
        .exam-sidebar.hidden-panel {
            display: none;
        }

        /* QUESTIONS CONTAINER */
        #questionsContainer {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
            display: flex;
            align-items: center;
        }

        /* QUESTION CARD */
        .question-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 22px 28px;
            width: 100%;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: all 0.2s;
            border-left: 5px solid transparent;
        }
        .question-card.answered {
            border-left-color: #10b981;
        }
        .question-card.current {
            box-shadow: 0 4px 20px rgba(79, 70, 229, 0.2);
            border-left-color: #4f46e5;
        }

        .question-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }
        .question-number {
            background: #4f46e5;
            color: white;
            font-weight: 700;
            padding: 6px 14px;
            border-radius: 18px;
            font-size: 0.9rem;
        }
        .question-type {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 500;
        }
        .question-type.comune { background: #dbeafe; color: #1e40af; }
        .question-type.specifico { background: #fef3c7; color: #92400e; }
        .question-type.logica { background: #e0e7ff; color: #4338ca; }
        .question-type.situazionale { background: #fce7f3; color: #be185d; }

        .question-text {
            color: var(--text-primary);
            font-weight: 500;
            line-height: 1.6;
            margin-bottom: 18px;
            font-size: 1.05rem;
        }

        /* OPTIONS */
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .option {
            display: flex;
            align-items: center;
            padding: 14px 18px;
            background: var(--bg-option);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            color: var(--text-primary);
        }
        .option:hover {
            background: var(--bg-option-hover);
            border-color: var(--accent-color);
        }
        .option.selected {
            background: var(--bg-option-selected);
            border-color: var(--accent-color);
        }
        .option.correct {
            background: #dcfce7;
            border-color: #10b981;
        }
        .option.wrong {
            background: #fee2e2;
            border-color: #ef4444;
        }
        .option.show-correct {
            background: #dcfce7;
            border-color: #10b981;
        }
        .option-letter {
            font-weight: 700;
            color: #4f46e5;
            margin-right: 12px;
            min-width: 24px;
        }
        .option.selected .option-letter {
            color: var(--accent-color);
        }
        [data-theme="dark"] .option.selected .option-letter {
            color: #c7d2fe;
        }
        .option-text {
            flex: 1;
            color: var(--text-secondary);
        }
        .option-icon {
            margin-left: auto;
            font-size: 1.1rem;
        }

        /* EXPLANATION PANEL (RIGHT SIDEBAR) */
        .explanation-panel {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .explanation-panel h3 {
            color: var(--accent-color);
            font-size: 1rem;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-light);
        }
        .explanation-panel .no-answer {
            color: var(--text-muted);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 30px;
        }
        .explanation-content {
            overflow-y: auto;
        }
        .explanation-content p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .correct-answer-box {
            background: var(--correct-bg);
            border-left: 4px solid var(--correct-border);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 15px;
        }
        .correct-answer-box .label {
            font-size: 0.75rem;
            color: var(--correct-border);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .correct-answer-box .answer {
            color: var(--correct-text);
            font-weight: 500;
        }

        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 32px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.45);
        }
        .btn-secondary {
            background: white;
            color: #4f46e5;
            border: 2px solid #4f46e5;
        }
        .btn-secondary:hover {
            background: #eef2ff;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-start {
            padding: 16px 48px;
            font-size: 1.1rem;
            border-radius: 14px;
            margin-top: 10px;
        }

        .action-bar {
            display: flex;
            justify-content: center;
            gap: 12px;
            padding: 15px 0;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        /* RESULTS DASHBOARD */
        .results-container {
            display: none;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }
        .results-container.show {
            display: block;
        }

        /* TOP SECTION: Score + Stats */
        .results-top {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: stretch;
        }

        /* SCORE CARD */
        .score-card {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            position: relative;
            overflow: hidden;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .score-card::before {
            content: '';
            position: absolute;
            top: -30%;
            right: -30%;
            width: 80%;
            height: 80%;
            background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
        }
        .score-card-title {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .score-circle-container {
            position: relative;
            width: 100px;
            height: 100px;
            margin: 0 auto 10px;
        }
        .score-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        .score-circle-bg {
            fill: none;
            stroke: rgba(255,255,255,0.2);
            stroke-width: 8;
        }
        .score-circle-fill {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-out;
        }
        .score-circle-fill.passed { stroke: #86efac; }
        .score-circle-fill.failed { stroke: #fca5a5; }
        .score-value {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }
        .score-number {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
            line-height: 1;
        }
        .score-max {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .results-status {
            font-size: 0.75rem;
            padding: 6px 14px;
            border-radius: 15px;
            display: inline-block;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        .results-status.passed {
            background: rgba(134, 239, 172, 0.3);
            color: #86efac;
        }
        .results-status.failed {
            background: rgba(252, 165, 165, 0.3);
            color: #fca5a5;
        }

        /* STATS + CATEGORIES PANEL */
        .results-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* STATS ROW */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .stat-card {
            background: var(--bg-card);
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 6px var(--shadow-color);
            border-left: 3px solid;
        }
        .stat-card.green { border-left-color: #10b981; }
        .stat-card.red { border-left-color: #ef4444; }
        .stat-card.gray { border-left-color: #94a3b8; }
        .stat-card.blue { border-left-color: #4f46e5; }
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
        }
        .stat-card.green .stat-value { color: #10b981; }
        .stat-card.red .stat-value { color: #ef4444; }
        .stat-card.gray .stat-value { color: var(--text-muted); }
        .stat-card.blue .stat-value { color: #4f46e5; }
        .stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-top: 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* CATEGORIES */
        .categories-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 6px var(--shadow-color);
        }
        .categories-card h3 {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .category-item {
            background: var(--bg-primary);
            padding: 10px;
            border-radius: 8px;
        }
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .category-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.7rem;
        }
        .category-score {
            font-size: 0.65rem;
            color: var(--text-secondary);
            font-weight: 600;
        }
        .category-bar {
            height: 5px;
            background: var(--border-color);
            border-radius: 3px;
            overflow: hidden;
        }
        .category-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.8s ease-out;
        }
        .category-fill.excellent { background: linear-gradient(90deg, #10b981, #34d399); }
        .category-fill.good { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .category-fill.medium { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
        .category-fill.poor { background: linear-gradient(90deg, #ef4444, #f87171); }

        /* RECOMMENDATIONS */
        .recommendations-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 6px var(--shadow-color);
        }
        .recommendations-card h3 {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .recommendations-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        .rec-item {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 8px;
            border-left: 3px solid;
        }
        .rec-item.critical { border-left-color: #ef4444; }
        .rec-item.warning { border-left-color: #f59e0b; }
        .rec-item.success { border-left-color: #10b981; }
        .rec-icon { font-size: 1rem; flex-shrink: 0; }
        .rec-text h4 {
            color: var(--text-primary);
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
        .rec-text p {
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
            margin: 0;
        }
        .rec-link {
            color: var(--accent-color);
            font-size: 0.75rem;
            text-decoration: none;
            font-weight: 500;
        }
        .rec-link:hover { text-decoration: underline; }

        /* REVIEW CARD */
        .review-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .review-header h3 {
            color: var(--text-primary);
            font-size: 0.95rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .review-toggle {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        .review-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 12px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.7rem;
            color: var(--text-secondary);
        }
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        .legend-dot.correct { background: #10b981; }
        .legend-dot.wrong { background: #ef4444; }
        .legend-dot.skipped { background: #94a3b8; }
        #reviewContainer {
            display: none;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        #reviewContainer.show {
            display: block;
        }
        .review-question {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid;
        }
        .review-question.correct { border-left-color: #10b981; }
        .review-question.wrong { border-left-color: #ef4444; }
        .review-question.skipped { border-left-color: #94a3b8; }
        .review-question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .review-question-num {
            background: var(--accent-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .review-question-type {
            background: var(--border-color);
            color: var(--text-secondary);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        .review-question-status {
            font-size: 0.8rem;
            font-weight: 600;
        }
        .review-question-status.correct { color: #10b981; }
        .review-question-status.wrong { color: #ef4444; }
        .review-question-status.skipped { color: #94a3b8; }
        .review-question-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .review-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        .review-option {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .review-option.correct-answer {
            background: #dcfce7;
            border-color: #10b981;
            color: #166534;
        }
        .review-option.wrong-answer {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .review-option-letter {
            font-weight: 700;
            flex-shrink: 0;
        }

        /* COLLAPSIBLE SECTIONS */
        .collapsible-section {
            background: var(--bg-card);
            border-radius: 14px;
            box-shadow: 0 2px 8px var(--shadow-color);
            margin-bottom: 12px;
            overflow: hidden;
        }
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            user-select: none;
        }
        .collapsible-header:hover {
            background: var(--bg-primary);
        }
        .collapsible-header h3 {
            color: var(--text-primary);
            font-size: 0.85rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .collapsible-toggle {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: transform 0.2s;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.show {
            max-height: 300px;
            overflow-y: auto;
        }
        .collapsible-content-inner {
            padding: 0 15px 15px;
        }

        /* ACTION BUTTONS */
        .results-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 30px;
        }

        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .score-circle-container {
                width: 150px;
                height: 150px;
            }
            .score-number {
                font-size: 2rem;
            }
        }

        /* START SCREEN */
        .start-screen {
            text-align: center;
            padding: 0;
        }
        .start-screen h2 {
            display: none;
        }
        .exam-info {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        .exam-info-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .exam-info-item {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-option);
            border: 1px solid var(--border-color);
            border-radius: 12px;
        }
        .exam-info-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1;
        }
        .exam-info-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* FOOTER */
        .footer {
            text-align: center;
            padding: 12px;
            color: var(--text-muted);
            font-size: 0.8rem;
            flex-shrink: 0;
        }
        .start-mode .footer {
            padding: 10px;
            margin-top: 8px;
        }
        .exam-mode .footer {
            display: none;
        }

        /* PRINT STYLES */
        @media print {
            body { background: white; }
            .stats-bar, .action-bar, .question-nav, .btn, .header-buttons { display: none !important; }
            .container { max-width: 100%; padding: 0; }
            .container.start-mode { min-height: auto; }
            .question-card {
                box-shadow: none;
                border: 1px solid #e2e8f0;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            .header-exam {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                margin-bottom: 20px;
            }
            .exam-info {
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }
            .instructions {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            #examScreen, .exam-layout, .exam-sidebar {
                display: none !important;
            }
            #printContainer {
                display: block !important;
            }
        }

        #printContainer {
            display: none;
        }

        /* SOURCES BOX - hidden in start screen, shown on info click */
        .sources-box {
            display: none;
        }

        /* SOCIAL LINKS */
        .social-links {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 16px;
        }
        .social-links a {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: #eef2ff;
            color: #4f46e5;
            text-decoration: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }
        .social-links a:hover {
            background: #4f46e5;
            color: white;
            transform: translateY(-1px);
        }

        /* RESPONSIVE */
        @media (max-width: 900px) {
            .exam-sidebar {
                width: 100%;
                order: 2;
            }
            .exam-layout {
                flex-direction: column;
            }
            .container {
                max-width: 100%;
            }
        }
        @media (max-width: 768px) {
            html, body { height: auto; min-height: 100%; overflow-y: auto !important; }
            .container { padding: 12px; }
            .container.start-mode { padding: 15px; min-height: auto; height: auto; justify-content: flex-start; padding-top: 20px; }
            .container.exam-mode { height: auto; min-height: 100vh; overflow: visible; justify-content: flex-start; padding-top: 15px; }
            .exam-layout { overflow: visible; flex-direction: column; }
            .exam-main { overflow: visible; }
            .exam-sidebar { width: 100%; margin-top: 15px; }
            #questionsContainer { overflow: visible; }
            .header-exam { padding: 16px; padding-top: 45px; margin-bottom: 16px; }
            .header-exam h1 { font-size: 1.2rem; }
            .header-exam h2 { font-size: 0.9rem; }
            .header-buttons { top: 10px; right: 10px; }
            .pdf-btn, .back-btn { padding: 6px 10px; font-size: 0.75rem; }
            .exam-info { padding: 16px; }
            .exam-info-grid { grid-template-columns: repeat(2, 1fr); gap: 12px; }
            .exam-info-item { padding: 14px 10px; }
            .exam-info-value { font-size: 1.8rem; }
            .exam-info-label { font-size: 0.8rem; }
            .instructions { padding: 14px 16px; }
            .instructions h3 { font-size: 1rem; }
            .instructions ul { font-size: 0.9rem; }
            .social-links { gap: 10px; flex-wrap: wrap; justify-content: center; }
            .social-links a { padding: 10px 16px; font-size: 0.9rem; }
            .btn-start { padding: 16px 40px; font-size: 1.1rem; width: 100%; margin-top: 10px; }
            .footer { font-size: 0.75rem; padding: 15px; }
            /* Results Dashboard responsive 768 */
            .results-container { padding: 15px; }
            .results-top { flex-direction: column; gap: 15px; }
            .score-card { min-width: auto; padding: 15px; }
            .score-circle-container { width: 90px; height: 90px; }
            .score-number { font-size: 1.6rem; }
            .results-main { gap: 12px; }
            .stats-row { grid-template-columns: repeat(4, 1fr); gap: 8px; }
            .stat-card { padding: 10px 6px; }
            .stat-value { font-size: 1.2rem; }
            .stat-label { font-size: 0.6rem; }
            .categories-card { padding: 12px; }
            .categories-card h3 { font-size: 0.8rem; }
            .categories-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .recommendations-card { padding: 12px; }
            .recommendations-list { grid-template-columns: 1fr; }
            .review-card { padding: 12px; }
            .review-options { grid-template-columns: 1fr; }
            .results-actions { gap: 10px; margin-top: 15px; }
        }
        @media (max-width: 480px) {
            .container.start-mode { padding: 12px; }
            .header-exam { padding: 14px; padding-top: 45px; margin-bottom: 12px; }
            .header-exam h1 { font-size: 1rem; }
            .header-exam h2 { font-size: 0.8rem; }
            .pdf-btn, .back-btn { padding: 5px 8px; font-size: 0.7rem; }
            .theme-toggle { padding: 5px 8px; font-size: 0.7rem; top: 10px; left: 10px; }
            .header-buttons { gap: 4px; }
            .exam-info { padding: 12px; }
            .exam-info-grid { gap: 8px; }
            .exam-info-item { padding: 10px 8px; }
            .exam-info-value { font-size: 1.5rem; }
            .exam-info-label { font-size: 0.7rem; }
            .instructions { padding: 12px; }
            .instructions h3 { font-size: 0.9rem; }
            .instructions ul { font-size: 0.85rem; margin-left: 16px; }
            .social-links a { padding: 8px 12px; font-size: 0.8rem; }
            /* Results Dashboard responsive 480 */
            .results-container { padding: 10px; }
            .results-top { gap: 12px; }
            .score-card { padding: 12px; }
            .score-card-title { font-size: 0.7rem; }
            .score-circle-container { width: 80px; height: 80px; }
            .score-number { font-size: 1.4rem; }
            .results-status { font-size: 0.7rem; padding: 5px 10px; }
            .stats-row { grid-template-columns: repeat(2, 1fr); gap: 6px; }
            .stat-card { padding: 8px 6px; }
            .stat-value { font-size: 1.1rem; }
            .categories-card { padding: 10px; }
            .categories-grid { grid-template-columns: 1fr; gap: 6px; }
            .category-item { padding: 8px; }
            .recommendations-card { padding: 10px; }
            .rec-item { padding: 8px; }
            .rec-text h4 { font-size: 0.7rem; }
            .rec-text p { font-size: 0.65rem; }
            .review-card { padding: 10px; }
            .review-question { padding: 10px; margin-bottom: 8px; }
            .review-question-text { font-size: 0.75rem; }
            .review-option { padding: 6px 8px; font-size: 0.65rem; }
            .results-actions { flex-direction: column; gap: 8px; }
            .results-actions .btn { width: 100%; padding: 12px; }
            .btn-start { padding: 14px 30px; font-size: 1rem; }
        }

        /* HIDDEN */
        .hidden { display: none !important; }

        /* PAUSE BUTTON */
        .pause-btn {
            margin-top: 6px;
            padding: 5px 12px;
            border: 1px solid rgba(255,255,255,0.5);
            background: rgba(255,255,255,0.2);
            color: white;
            border-radius: 5px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .pause-btn:hover {
            background: rgba(255,255,255,0.3);
            border-color: white;
        }
        .pause-btn.paused {
            background: rgba(255,255,255,0.9);
            color: #4f46e5;
            border-color: white;
        }

        /* PAUSE OVERLAY */
        .pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .pause-overlay .pause-message {
            background: white;
            padding: 40px 60px;
            border-radius: 16px;
            text-align: center;
        }
        .pause-overlay h2 {
            color: #4f46e5;
            margin-bottom: 10px;
        }
        .pause-overlay p {
            color: #64748b;
            margin-bottom: 20px;
        }

    </style>
</head>
<body>

<div class="container start-mode" id="mainContainer">
    <!-- HEADER -->
    <div class="header-exam">
        <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">&#9790; Dark</button>
        <div class="header-buttons">
            <a href="https://fracabu.github.io/guida-mic/" class="back-btn">&#8592; Guida</a>
            <button class="pdf-btn" onclick="printQuiz()">Stampa PDF</button>
        </div>
        <h1>CONCORSO MIC 1800 ASSISTENTI</h1>
        <h2>Simulazione Prova Scritta - Profilo Amministrativo</h2>
    </div>

    <!-- START SCREEN -->
    <div id="startScreen" class="start-screen">
        <div class="exam-info">
            <div class="exam-info-grid">
                <div class="exam-info-item">
                    <div class="exam-info-value">40</div>
                    <div class="exam-info-label">Quesiti</div>
                </div>
                <div class="exam-info-item">
                    <div class="exam-info-value">60</div>
                    <div class="exam-info-label">Minuti</div>
                </div>
                <div class="exam-info-item">
                    <div class="exam-info-value">30</div>
                    <div class="exam-info-label">Punti Max</div>
                </div>
                <div class="exam-info-item">
                    <div class="exam-info-value">21</div>
                    <div class="exam-info-label">Soglia</div>
                </div>
            </div>

            <div class="instructions">
                <h3>Punteggio RIPAM</h3>
                <ul>
                    <li><span class="highlight">Quesiti 1-32:</span> Corretta +0,75 | Errata -0,25 | Non data 0</li>
                    <li><span class="highlight">Quesiti 33-40:</span> Piu' efficace +0,75 | Neutra +0,375 | Meno efficace 0</li>
                </ul>
            </div>

            <div class="social-links">
                <a href="https://t.me/ripam3997" target="_blank">Telegram</a>
                <a href="https://www.facebook.com/groups/ripam3997" target="_blank">Facebook</a>
                <a href="index.html">Guida RIPAM</a>
            </div>
        </div>

        <button class="btn btn-primary btn-start" onclick="startExam()">
            Inizia Simulazione
        </button>
    </div>

    <!-- EXAM SCREEN -->
    <div id="examScreen" class="hidden">
        <!-- STATS BAR -->
        <div class="stats-bar">
            <div class="stat-box timer" id="timerBox">
                <div class="stat-label">Tempo Rimasto</div>
                <div class="stat-value" id="timer">60:00</div>
                <button class="pause-btn" id="pauseBtn" onclick="togglePause()">&#10074;&#10074; Pausa</button>
            </div>
            <div class="stat-box">
                <div class="stat-label">Risposte</div>
                <div class="stat-value" id="answeredCount">0/40</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Non Risposte</div>
                <div class="stat-value" id="skippedCount">40</div>
            </div>
        </div>

        <!-- TWO COLUMN LAYOUT -->
        <div class="exam-layout">
            <!-- LEFT: Question -->
            <div class="exam-main">
                <!-- PROGRESS -->
                <div class="progress-container">
                    <div class="progress-header">
                        <span>Avanzamento</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                </div>

                <!-- QUESTIONS CONTAINER -->
                <div id="questionsContainer"></div>

                <!-- ACTION BAR -->
                <div class="action-bar">
                    <button class="btn btn-secondary" onclick="previousQuestion()">Precedente</button>
                    <button class="btn btn-secondary" onclick="nextQuestion()">Successiva</button>
                    <button class="btn btn-primary" onclick="submitExam()">Consegna Esame</button>
                </div>
            </div>

            <!-- RIGHT: Explanation Panel -->
            <div class="exam-sidebar" id="explanationSidebar">
                <div class="explanation-panel">
                    <h3>Spiegazione</h3>
                    <div id="explanationContent">
                        <p class="no-answer">Seleziona una risposta per vedere la spiegazione</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="resultsScreen" class="results-container">
        <!-- TOP: Score + Stats/Categories -->
        <div class="results-top">
            <!-- Score Card -->
            <div class="score-card">
                <div class="score-card-title">Punteggio</div>
                <div class="score-circle-container">
                    <svg class="score-circle" viewBox="0 0 100 100">
                        <circle class="score-circle-bg" cx="50" cy="50" r="42"></circle>
                        <circle class="score-circle-fill" id="scoreCircle" cx="50" cy="50" r="42"
                                stroke-dasharray="264" stroke-dashoffset="264"></circle>
                    </svg>
                    <div class="score-value">
                        <span class="score-number" id="finalScore">0</span>
                        <span class="score-max">/ 30</span>
                    </div>
                </div>
                <div class="results-status" id="examStatus">-</div>
            </div>

            <!-- Stats + Categories -->
            <div class="results-main">
                <div class="stats-row">
                    <div class="stat-card green">
                        <div class="stat-value" id="correctCount">0</div>
                        <div class="stat-label">Corrette</div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-value" id="wrongCount">0</div>
                        <div class="stat-label">Errate</div>
                    </div>
                    <div class="stat-card gray">
                        <div class="stat-value" id="notAnsweredCount">0</div>
                        <div class="stat-label">Saltate</div>
                    </div>
                    <div class="stat-card blue">
                        <div class="stat-value" id="timeUsed">-</div>
                        <div class="stat-label">Tempo</div>
                    </div>
                </div>

                <div class="categories-card">
                    <h3>&#128202; Analisi per Categoria</h3>
                    <div class="categories-grid" id="categoryBreakdown"></div>
                </div>
            </div>
        </div>

        <!-- RECOMMENDATIONS - Collapsible -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection('recommendations')">
                <h3>&#128161; Consigli di Studio</h3>
                <button class="collapsible-toggle" id="recommendationsToggle">Mostra</button>
            </div>
            <div class="collapsible-content" id="recommendationsContent">
                <div class="collapsible-content-inner" id="recommendationsContainer"></div>
            </div>
        </div>

        <!-- REVIEW SECTION - Collapsible -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleSection('review')">
                <h3>&#128269; Revisione Risposte</h3>
                <button class="collapsible-toggle" id="reviewToggle">Mostra</button>
            </div>
            <div class="collapsible-content" id="reviewContent">
                <div class="collapsible-content-inner">
                    <div class="review-legend">
                        <div class="legend-item"><div class="legend-dot correct"></div><span>Corretta</span></div>
                        <div class="legend-item"><div class="legend-dot wrong"></div><span>Errata</span></div>
                        <div class="legend-item"><div class="legend-dot skipped"></div><span>Saltata</span></div>
                    </div>
                    <div id="reviewContainer"></div>
                </div>
            </div>
        </div>

        <!-- ACTIONS -->
        <div class="results-actions">
            <button class="btn btn-secondary" onclick="downloadPDF()">&#128196; Scarica PDF</button>
            <button class="btn btn-primary" onclick="restartExam()">&#128260; Nuova Simulazione</button>
        </div>
    </div>

    <div class="footer">
        RIPAM STUDIO - Simulatore basato sul Bando Ufficiale (Art. 6)
    </div>
</div>

<!-- PAUSE OVERLAY -->
<div id="pauseOverlay" class="pause-overlay hidden">
    <div class="pause-message">
        <h2>PAUSA</h2>
        <p>Il timer e' in pausa</p>
        <button class="btn btn-primary" onclick="togglePause()">Riprendi</button>
    </div>
</div>

<!-- PRINT CONTAINER -->
<div id="printContainer"></div>

<!-- html2pdf.js for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
// ==================== QUIZ DATA ====================
const questions = [
    // QUESITI COMUNI (1-10) - Diritto Amministrativo, Penale, CAD, etc.
    {
        id: 1,
        type: "comune",
        typeLabel: "Dir. Amministrativo",
        text: "Ai sensi dell'art. 2 della L. 241/1990, entro quale termine devono concludersi i procedimenti amministrativi di competenza delle amministrazioni statali, nei casi in cui non sia previsto un termine diverso?",
        options: ["Trenta giorni", "Sessanta giorni", "Novanta giorni", "Centoventi giorni"],
        correct: 0,
        explanation: "L'art. 2, comma 2, della L. 241/1990 stabilisce che i procedimenti amministrativi di competenza delle amministrazioni statali devono concludersi entro 30 giorni, salvo che disposizioni di legge o regolamenti non prevedano un termine diverso."
    },
    {
        id: 2,
        type: "comune",
        typeLabel: "Dir. Amministrativo",
        text: "A chi affida l'art. 6 della L. 241/1990 il compito di curare le comunicazioni, le pubblicazioni e le notificazioni previste dalle leggi e dai regolamenti?",
        options: ["Al dirigente dell'unita' organizzativa", "All'organo di indirizzo politico", "Al segretario generale", "Al responsabile del procedimento"],
        correct: 3,
        explanation: "L'art. 6, comma 1, lett. e) della L. 241/1990 attribuisce al responsabile del procedimento il compito di curare le comunicazioni, le pubblicazioni e le notificazioni previste dalle leggi e dai regolamenti."
    },
    {
        id: 3,
        type: "comune",
        typeLabel: "Dir. Amministrativo",
        text: "Ai sensi della L. 241/1990, la motivazione del provvedimento amministrativo NON e' richiesta per:",
        options: ["I provvedimenti di diniego", "I provvedimenti sanzionatori", "Gli atti normativi e per quelli a contenuto generale", "I provvedimenti che incidono su diritti soggettivi"],
        correct: 2,
        explanation: "L'art. 3, comma 2, della L. 241/1990 prevede espressamente che la motivazione non e' richiesta per gli atti normativi e per quelli a contenuto generale, in quanto questi ultimi non necessitano di una giustificazione specifica caso per caso."
    },
    {
        id: 4,
        type: "comune",
        typeLabel: "Dir. Amministrativo",
        text: "Ai sensi dell'art. 21-septies della L. 241/1990, un provvedimento che manchi degli elementi essenziali e' considerato:",
        options: ["Annullabile", "Nullo", "Irregolare", "Inefficace"],
        correct: 1,
        explanation: "L'art. 21-septies della L. 241/1990 stabilisce che e' nullo il provvedimento amministrativo che manca degli elementi essenziali, che e' viziato da difetto assoluto di attribuzione, che e' stato adottato in violazione o elusione del giudicato, nonche' negli altri casi espressamente previsti dalla legge."
    },
    {
        id: 5,
        type: "comune",
        typeLabel: "Dir. Penale PA",
        text: "Ai sensi dell'art. 317 c.p., il pubblico ufficiale che, abusando della sua qualita' o dei suoi poteri, costringe taluno a dare o promettere indebitamente denaro o altra utilita', commette il reato di:",
        options: ["Corruzione", "Peculato", "Concussione", "Abuso d'ufficio"],
        correct: 2,
        explanation: "L'art. 317 c.p. definisce la concussione come il reato commesso dal pubblico ufficiale o dall'incaricato di pubblico servizio che, abusando della sua qualita' o dei suoi poteri, costringe taluno a dare o promettere indebitamente, a lui o a un terzo, denaro o altra utilita'."
    },
    {
        id: 6,
        type: "comune",
        typeLabel: "Dir. Penale PA",
        text: "Il reato di peculato (art. 314 c.p.) si configura quando il pubblico ufficiale:",
        options: ["Si appropria di denaro o altra cosa mobile altrui di cui ha il possesso per ragione del suo ufficio", "Riceve denaro per compiere un atto del suo ufficio", "Omette un atto del suo ufficio", "Rivela notizie d'ufficio che devono rimanere segrete"],
        correct: 0,
        explanation: "Il peculato (art. 314 c.p.) si configura quando il pubblico ufficiale o l'incaricato di pubblico servizio, avendo per ragione del suo ufficio o servizio il possesso o comunque la disponibilita' di denaro o di altra cosa mobile altrui, se ne appropria."
    },
    {
        id: 7,
        type: "comune",
        typeLabel: "CAD",
        text: "Ai sensi del D.Lgs. 82/2005 (CAD), cosa si intende per 'documento informatico'?",
        options: ["Solo i documenti firmati digitalmente", "Solo i documenti della Pubblica Amministrazione", "I documenti cartacei scannerizzati", "Il documento elettronico che contiene la rappresentazione informatica di atti, fatti o dati giuridicamente rilevanti"],
        correct: 3,
        explanation: "L'art. 1, comma 1, lett. p) del CAD definisce il documento informatico come 'il documento elettronico che contiene la rappresentazione informatica di atti, fatti o dati giuridicamente rilevanti'."
    },
    {
        id: 8,
        type: "comune",
        typeLabel: "CAD",
        text: "Ai sensi del CAD, il domicilio digitale e':",
        options: ["L'indirizzo di posta elettronica ordinaria", "Un indirizzo elettronico eletto presso un servizio di posta elettronica certificata o altro servizio qualificato di recapito", "L'indirizzo del sito web personale", "L'indirizzo email aziendale"],
        correct: 1,
        explanation: "L'art. 1, comma 1, lett. n-ter) del CAD definisce il domicilio digitale come 'un indirizzo elettronico eletto presso un servizio di posta elettronica certificata o un servizio elettronico di recapito certificato qualificato'."
    },
    {
        id: 9,
        type: "comune",
        typeLabel: "Inglese A2",
        text: "Choose the correct option: 'I _____ to the office every day by bus.'",
        options: ["goes", "going", "gone", "go"],
        correct: 3,
        explanation: "Con il soggetto 'I' (prima persona singolare) si usa la forma base del verbo 'go'. 'Goes' si usa con la terza persona singolare (he/she/it goes)."
    },
    {
        id: 10,
        type: "comune",
        typeLabel: "Informatica",
        text: "Quale tra i seguenti e' un software di elaborazione testi?",
        options: ["Microsoft Excel", "Microsoft Access", "Microsoft Word", "Microsoft PowerPoint"],
        correct: 2,
        explanation: "Microsoft Word e' il software di elaborazione testi (word processor) della suite Microsoft Office. Excel e' un foglio di calcolo, Access e' un database, PowerPoint e' un software per presentazioni."
    },

    // QUESITI SPECIFICI PROFILO (11-25) - Contabilita', Dir. UE, Pubblico Impiego
    {
        id: 11,
        type: "specifico",
        typeLabel: "Contabilita' Stato",
        text: "Ai sensi della L. 196/2009, il bilancio dello Stato e' approvato:",
        options: ["Con decreto del Presidente della Repubblica", "Con decreto del Ministro dell'Economia", "Con delibera del Consiglio dei Ministri", "Con legge"],
        correct: 3,
        explanation: "La L. 196/2009 (legge di contabilita' e finanza pubblica) prevede che il bilancio dello Stato sia approvato con legge dal Parlamento. Questo garantisce il controllo democratico sulla gestione delle risorse pubbliche."
    },
    {
        id: 12,
        type: "specifico",
        typeLabel: "Contabilita' Stato",
        text: "Il rendiconto generale dello Stato e' presentato alle Camere entro:",
        options: ["Il 30 giugno", "Il 30 aprile", "Il 31 luglio", "Il 30 settembre"],
        correct: 0,
        explanation: "Ai sensi dell'art. 35 della L. 196/2009, il rendiconto generale dello Stato e' presentato dal Ministro dell'economia e delle finanze alle Camere entro il 30 giugno dell'anno successivo a quello di riferimento."
    },
    {
        id: 13,
        type: "specifico",
        typeLabel: "Dir. Unione Europea",
        text: "Il Parlamento Europeo e':",
        options: ["Nominato dai governi degli Stati membri", "Eletto a suffragio universale diretto dai cittadini dell'UE", "Composto dai capi di Stato e di governo", "Designato dalla Commissione Europea"],
        correct: 1,
        explanation: "Il Parlamento Europeo e' l'unica istituzione dell'UE eletta direttamente dai cittadini europei. Le elezioni si tengono ogni 5 anni a suffragio universale diretto."
    },
    {
        id: 14,
        type: "specifico",
        typeLabel: "Dir. Unione Europea",
        text: "I regolamenti dell'Unione Europea sono:",
        options: ["Vincolanti solo per gli Stati che li recepiscono", "Mere raccomandazioni", "Direttamente applicabili in tutti gli Stati membri", "Applicabili solo previa ratifica parlamentare"],
        correct: 2,
        explanation: "I regolamenti UE hanno portata generale, sono obbligatori in tutti i loro elementi e direttamente applicabili in ciascuno degli Stati membri, senza necessita' di atti di recepimento nazionali (art. 288 TFUE)."
    },
    {
        id: 15,
        type: "specifico",
        typeLabel: "Dir. Unione Europea",
        text: "La Corte di Giustizia dell'Unione Europea ha sede a:",
        options: ["Bruxelles", "Strasburgo", "Lussemburgo", "L'Aia"],
        correct: 2,
        explanation: "La Corte di Giustizia dell'Unione Europea ha sede a Lussemburgo. Bruxelles ospita la Commissione e il Consiglio, Strasburgo il Parlamento Europeo per le sessioni plenarie, L'Aia la Corte Internazionale di Giustizia (ONU)."
    },
    {
        id: 16,
        type: "specifico",
        typeLabel: "Pubblico Impiego",
        text: "Ai sensi del D.Lgs. 165/2001, il rapporto di lavoro dei dipendenti pubblici e' disciplinato:",
        options: ["Esclusivamente dal diritto pubblico", "Solo dai contratti collettivi", "Esclusivamente dalle leggi speciali", "Dalle disposizioni del codice civile e dalle leggi sui rapporti di lavoro subordinato nell'impresa"],
        correct: 3,
        explanation: "L'art. 2, comma 2, del D.Lgs. 165/2001 stabilisce che i rapporti di lavoro dei dipendenti pubblici sono disciplinati dalle disposizioni del capo I, titolo II, del libro V del codice civile e dalle leggi sui rapporti di lavoro subordinato nell'impresa (c.d. privatizzazione del pubblico impiego)."
    },
    {
        id: 17,
        type: "specifico",
        typeLabel: "Pubblico Impiego",
        text: "Il Codice di comportamento dei dipendenti pubblici (DPR 62/2013) prevede che il dipendente:",
        options: ["Non debba accettare regali o altre utilita', salvo quelli di modico valore", "Possa accettare regali di qualsiasi valore", "Possa accettare regali solo dai superiori", "Debba rifiutare qualsiasi forma di cortesia"],
        correct: 0,
        explanation: "L'art. 4 del DPR 62/2013 vieta al dipendente di accettare regali o altre utilita', salvo quelli di modico valore (generalmente non superiore a 150 euro) e quelli d'uso nell'ambito delle normali relazioni di cortesia."
    },
    {
        id: 18,
        type: "specifico",
        typeLabel: "Pubblico Impiego",
        text: "La sanzione disciplinare del licenziamento senza preavviso si applica, tra l'altro:",
        options: ["Per un singolo ritardo ingiustificato", "Per mancata partecipazione a una riunione", "Per uso personale del telefono d'ufficio", "Per falsa attestazione della presenza in servizio"],
        correct: 3,
        explanation: "L'art. 55-quater del D.Lgs. 165/2001 prevede il licenziamento disciplinare senza preavviso per falsa attestazione della presenza in servizio (es. 'badge' timbrato da altri), che costituisce anche reato."
    },
    {
        id: 19,
        type: "specifico",
        typeLabel: "Pubblico Impiego",
        text: "Ai sensi del D.Lgs. 165/2001, l'assunzione nelle amministrazioni pubbliche avviene:",
        options: ["Tramite procedure selettive che garantiscano imparzialita' e trasparenza", "Esclusivamente per chiamata diretta", "Su raccomandazione dei dirigenti", "Mediante sorteggio tra i candidati"],
        correct: 0,
        explanation: "L'art. 35 del D.Lgs. 165/2001 stabilisce che l'assunzione nelle PA avviene tramite procedure selettive conformi ai principi di economicita', celerita', imparzialita' e trasparenza, in attuazione dell'art. 97 della Costituzione."
    },
    {
        id: 20,
        type: "specifico",
        typeLabel: "Dir. Amministrativo",
        text: "Ai sensi del D.Lgs. 33/2013, le P.A. pubblicano i dati sui propri pagamenti in una sezione denominata:",
        options: ["Albo pretorio", "Archivio corrente", "Amministrazione trasparente", "Area riservata"],
        correct: 2,
        explanation: "Il D.Lgs. 33/2013 (decreto trasparenza) prevede che ogni PA abbia sul proprio sito una sezione 'Amministrazione trasparente' dove pubblicare dati, informazioni e documenti previsti dalla normativa sulla trasparenza."
    },
    {
        id: 21,
        type: "specifico",
        typeLabel: "Contabilita' Stato",
        text: "Il principio di annualita' del bilancio pubblico significa che:",
        options: ["Il bilancio deve essere approvato ogni anno", "Il bilancio puo' essere modificato una volta l'anno", "Le entrate e le spese sono riferite all'anno finanziario", "I residui si annullano ogni anno"],
        correct: 2,
        explanation: "Il principio di annualita' del bilancio (art. 81 Cost.) comporta che le previsioni di entrata e spesa siano riferite a un periodo di tempo determinato (anno finanziario) e che il bilancio sia approvato annualmente."
    },
    {
        id: 22,
        type: "specifico",
        typeLabel: "Dir. Unione Europea",
        text: "Le direttive dell'Unione Europea:",
        options: ["Sono immediatamente applicabili", "Vincolano gli Stati membri quanto al risultato da raggiungere, lasciando liberta' sulla forma e sui mezzi", "Non sono vincolanti", "Riguardano solo le istituzioni UE"],
        correct: 1,
        explanation: "Le direttive UE (art. 288 TFUE) vincolano gli Stati membri al raggiungimento di determinati risultati, lasciando loro la scelta della forma e dei mezzi. Devono essere recepite con atti nazionali entro un termine stabilito."
    },
    {
        id: 23,
        type: "specifico",
        typeLabel: "Pubblico Impiego",
        text: "Il periodo di prova per i dipendenti pubblici:",
        options: ["Non e' previsto", "Dura sempre 6 mesi", "E' deciso discrezionalmente dal dirigente", "E' disciplinato dai contratti collettivi"],
        correct: 3,
        explanation: "Il periodo di prova dei dipendenti pubblici e' disciplinato dai contratti collettivi nazionali di lavoro (CCNL) del comparto di appartenenza, che ne stabiliscono durata e modalita' di svolgimento."
    },
    {
        id: 24,
        type: "specifico",
        typeLabel: "Dir. Amministrativo",
        text: "L'accesso civico generalizzato (D.Lgs. 33/2013) consente:",
        options: ["L'accesso a dati e documenti detenuti dalle PA, ulteriori rispetto a quelli oggetto di pubblicazione", "L'accesso solo ai documenti gia' pubblicati", "L'accesso solo ai cittadini italiani", "L'accesso solo previa dimostrazione di un interesse qualificato"],
        correct: 0,
        explanation: "L'art. 5, comma 2, del D.Lgs. 33/2013 introduce l'accesso civico generalizzato (FOIA italiano), che consente a chiunque di accedere a dati e documenti detenuti dalle PA, anche diversi da quelli oggetto di pubblicazione obbligatoria, senza motivazione."
    },
    {
        id: 25,
        type: "specifico",
        typeLabel: "Pubblico Impiego",
        text: "Il mobbing sul luogo di lavoro:",
        options: ["E' sempre lecito se fatto dai superiori", "Non e' rilevante nel pubblico impiego", "Costituisce una condotta illecita che puo' dar luogo a responsabilita' civile e disciplinare", "E' sanzionato solo penalmente"],
        correct: 2,
        explanation: "Il mobbing e' una condotta illecita che viola l'art. 2087 del Codice Civile (obbligo di tutela dell'integrita' fisica e morale del lavoratore) e puo' dar luogo a responsabilita' civile, disciplinare e, in casi gravi, anche penale."
    },

    // QUESITI LOGICA (26-32)
    {
        id: 26,
        type: "logica",
        typeLabel: "Ragionamento verbale",
        text: "Individuare il termine che completa correttamente la proporzione: Pittore : Pennello = Scrittore : ?",
        options: ["Libro", "Carta", "Penna", "Inchiostro"],
        correct: 2,
        explanation: "La relazione e' tra un professionista e il suo strumento principale di lavoro. Il pittore usa il pennello per dipingere, lo scrittore usa la penna per scrivere. Il libro e' il prodotto, non lo strumento."
    },
    {
        id: 27,
        type: "logica",
        typeLabel: "Ragionamento verbale",
        text: "Quale parola NON appartiene al gruppo? MELA, PERA, CAROTA, BANANA, UVA",
        options: ["Mela", "Pera", "Carota", "Banana"],
        correct: 2,
        explanation: "Mela, pera, banana e uva sono tutti frutti. La carota e' invece una verdura (radice), quindi e' l'intruso nel gruppo."
    },
    {
        id: 28,
        type: "logica",
        typeLabel: "Ragionamento numerico",
        text: "Completare la serie: 2, 6, 18, 54, ?",
        options: ["108", "216", "72", "162"],
        correct: 3,
        explanation: "E' una progressione geometrica con ragione 3. Ogni numero si ottiene moltiplicando il precedente per 3: 23=6, 63=18, 183=54, 543=162."
    },
    {
        id: 29,
        type: "logica",
        typeLabel: "Ragionamento numerico",
        text: "Se 3 operai completano un lavoro in 12 giorni, in quanti giorni lo completerebbero 6 operai?",
        options: ["6 giorni", "24 giorni", "4 giorni", "8 giorni"],
        correct: 0,
        explanation: "E' un problema di proporzionalita' inversa. Se raddoppiano gli operai (da 3 a 6), il tempo si dimezza (da 12 a 6 giorni). Formula: 312 = 6x, quindi x = 36/6 = 6 giorni."
    },
    {
        id: 30,
        type: "logica",
        typeLabel: "Ragionamento critico",
        text: "Se tutti i medici sono laureati e Marco e' laureato, allora:",
        options: ["Marco e' sicuramente un medico", "Marco non puo' essere un medico", "Tutti i laureati sono medici", "Marco potrebbe essere un medico"],
        correct: 3,
        explanation: "Il fatto che tutti i medici siano laureati non implica che tutti i laureati siano medici. Marco, essendo laureato, potrebbe essere un medico, ma potrebbe anche essere un ingegnere, un avvocato, ecc."
    },
    {
        id: 31,
        type: "logica",
        typeLabel: "Ragionamento verbale",
        text: "VELOCE sta a LENTO come ALTO sta a:",
        options: ["Grande", "Lungo", "Basso", "Stretto"],
        correct: 2,
        explanation: "La relazione e' di antonimia (contrari). Veloce e lento sono opposti, cosi' come alto e basso sono opposti. Grande, lungo e stretto non sono contrari di alto."
    },
    {
        id: 32,
        type: "logica",
        typeLabel: "Ragionamento numerico",
        text: "Quale numero manca? 1, 4, 9, 16, ?, 36",
        options: ["20", "24", "25", "30"],
        correct: 2,
        explanation: "La serie e' composta dai quadrati dei numeri naturali: 1=1, 2=4, 3=9, 4=16, 5=25, 6=36. Il numero mancante e' quindi 25."
    },

    // QUESITI SITUAZIONALI (33-40)
    {
        id: 33,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Un collega commette ripetutamente errori che rallentano il lavoro del team. Come ti comporti?",
        options: [
            "Segnali immediatamente il problema al dirigente",
            "Ignori la situazione per non creare conflitti",
            "Critichi apertamente il collega durante una riunione",
            "Parli privatamente con il collega offrendoti di aiutarlo a migliorare"
        ],
        correct: 3,
        scoring: [0.375, 0, 0, 0.75],
        explanation: "L'approccio piu' efficace e' parlare privatamente con il collega, offrendo aiuto costruttivo. Questo rispetta la dignita' della persona e favorisce il miglioramento. Segnalare subito al dirigente puo' essere utile ma meno collaborativo."
    },
    {
        id: 34,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Un cittadino si presenta allo sportello molto agitato e alza la voce. Come reagisci?",
        options: [
            "Mantieni la calma, ascolti le sue ragioni e cerchi di risolvere il problema",
            "Rispondi alzando anche tu la voce per farti rispettare",
            "Chiami immediatamente la sicurezza",
            "Gli dici di tornare quando si sara' calmato"
        ],
        correct: 0,
        scoring: [0.75, 0, 0.375, 0],
        explanation: "Mantenere la calma e ascoltare e' la risposta piu' professionale. Spesso l'agitazione nasce da frustrazione: ascoltare e cercare soluzioni de-escalation la situazione. Chiamare la sicurezza e' appropriato solo in caso di pericolo reale."
    },
    {
        id: 35,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Ricevi istruzioni contrastanti da due superiori diversi. Come ti comporti?",
        options: [
            "Esegui le istruzioni del superiore che ti e' piu' simpatico",
            "Chiedi chiarimenti evidenziando il contrasto e cercando una soluzione condivisa",
            "Non fai nulla aspettando che si mettano d'accordo",
            "Esegui entrambe le istruzioni anche se contradditorie"
        ],
        correct: 1,
        scoring: [0, 0.75, 0, 0.375],
        explanation: "Chiedere chiarimenti evidenziando il contrasto e' l'approccio corretto. Permette di risolvere l'ambiguita' senza prendere decisioni arbitrarie. Non fare nulla o eseguire istruzioni contraddittorie sono entrambe opzioni inefficaci."
    },
    {
        id: 36,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Ti accorgi che un collega utilizza risorse dell'ufficio per fini personali. Cosa fai?",
        options: [
            "Fai finta di niente per non creare problemi",
            "Lo denunci immediatamente per iscritto al dirigente",
            "Ne parli con il collega facendogli presente che il comportamento non e' corretto",
            "Inizi anche tu a usare le risorse per fini personali"
        ],
        correct: 2,
        scoring: [0, 0.375, 0.75, 0],
        explanation: "Parlare prima con il collega e' l'approccio piu' costruttivo: gli dai la possibilita' di correggere il comportamento. La denuncia immediata, pur corretta, potrebbe essere sproporzionata per violazioni minori."
    },
    {
        id: 37,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Hai una scadenza urgente ma un collega ti chiede aiuto per un suo problema. Come gestisci la situazione?",
        options: [
            "Rifiuti seccamente dicendo che hai altro da fare",
            "Abbandoni il tuo lavoro per aiutare il collega",
            "Ignori completamente la richiesta",
            "Spieghi la tua situazione e proponi di aiutarlo appena possibile o di trovare insieme un'alternativa"
        ],
        correct: 3,
        scoring: [0, 0.375, 0, 0.75],
        explanation: "Comunicare la propria situazione e proporre alternative dimostra sia responsabilita' verso i propri compiti sia spirito collaborativo. Rifiutare seccamente o ignorare danneggia il rapporto; abbandonare il proprio lavoro e' irresponsabile."
    },
    {
        id: 38,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Durante una riunione, un collega presenta come propria un'idea che avevi condiviso con lui in precedenza. Come reagisci?",
        options: [
            "Non dici nulla durante la riunione ma ne parli con lui in privato dopo",
            "Lo interrompi accusandolo pubblicamente di plagio",
            "Abbandoni la riunione per protesta",
            "Inizi a parlare male del collega con gli altri"
        ],
        correct: 0,
        scoring: [0.75, 0, 0, 0],
        explanation: "Affrontare la questione in privato e' la scelta piu' matura e professionale. Evita imbarazzi pubblici e permette un confronto costruttivo. Le altre opzioni creerebbero solo conflitto e un ambiente di lavoro negativo."
    },
    {
        id: 39,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Ti viene assegnato un compito che ritieni non sia di tua competenza. Come ti comporti?",
        options: [
            "Rifiuti categoricamente di svolgerlo",
            "Lo svolgi lamentandoti con tutti i colleghi",
            "Chiedi chiarimenti al tuo superiore esponendo le tue perplessita' in modo costruttivo",
            "Lo deleghi a un collega senza informare nessuno"
        ],
        correct: 2,
        scoring: [0, 0.375, 0.75, 0],
        explanation: "Chiedere chiarimenti in modo costruttivo permette di capire le ragioni dell'assegnazione e, eventualmente, di trovare soluzioni. Rifiutare o delegare senza autorizzazione sono comportamenti scorretti; lamentarsi crea un clima negativo."
    },
    {
        id: 40,
        type: "situazionale",
        typeLabel: "Situazionale",
        text: "Noti un errore in un documento gia' firmato dal tuo dirigente. Cosa fai?",
        options: [
            "Correggi l'errore senza dire nulla a nessuno",
            "Non fai nulla perche' il documento e' gia' firmato",
            "Diffondi la notizia dell'errore tra i colleghi",
            "Segnali l'errore al dirigente proponendo come correggerlo"
        ],
        correct: 3,
        scoring: [0.375, 0, 0, 0.75],
        explanation: "Segnalare l'errore al dirigente con una proposta di soluzione e' l'approccio corretto. Dimostra attenzione, rispetto della gerarchia e proattivita'. Correggere autonomamente un documento firmato o non fare nulla sono entrambi comportamenti scorretti."
    }
];

// ==================== GAME STATE ====================
let currentQuestion = 0;
let userAnswers = new Array(questions.length).fill(null);
let timeRemaining = 60 * 60; // 60 minuti in secondi
let timerInterval = null;
let examStartTime = null;
let examEndTime = null;
let isPaused = false;

// ==================== FUNCTIONS ====================

function printQuiz() {
    const printContainer = document.getElementById('printContainer');
    printContainer.innerHTML = `
        <div class="header-exam" style="margin-bottom: 30px;">
            <h1>CONCORSO MIC 1800 ASSISTENTI</h1>
            <h2>Simulazione Prova Scritta - Profilo Amministrativo</h2>
        </div>
        <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px;">
            <p><strong>40 quesiti</strong> | <strong>60 minuti</strong> | <strong>Soglia: 21/30</strong></p>
        </div>
    `;

    questions.forEach((q, index) => {
        printContainer.innerHTML += `
            <div class="question-card" style="margin-bottom: 20px; page-break-inside: avoid;">
                <div class="question-header">
                    <span class="question-number">Domanda ${q.id}</span>
                    <span class="question-type ${q.type}">${q.typeLabel}</span>
                </div>
                <div class="question-text">${q.text}</div>
                <div class="options-list">
                    ${q.options.map((opt, idx) => `
                        <div class="option">
                            <span class="option-letter">${String.fromCharCode(65 + idx)})</span>
                            <span class="option-text">${opt}</span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });

    window.print();
}

function startExam() {
    document.getElementById('mainContainer').classList.remove('start-mode');
    document.getElementById('mainContainer').classList.add('exam-mode');
    document.getElementById('startScreen').classList.add('hidden');
    document.getElementById('examScreen').classList.remove('hidden');

    examStartTime = new Date();
    renderQuestion();
    startTimer();
}

function startTimer() {
    timerInterval = setInterval(() => {
        timeRemaining--;
        updateTimerDisplay();

        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            submitExam();
        }

        if (timeRemaining <= 300) { // 5 minuti
            document.getElementById('timerBox').classList.add('warning');
        }
    }, 1000);
}

function updateTimerDisplay() {
    const minutes = Math.floor(timeRemaining / 60);
    const seconds = timeRemaining % 60;
    document.getElementById('timer').textContent =
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

function togglePause() {
    isPaused = !isPaused;
    const pauseBtn = document.getElementById('pauseBtn');
    const pauseOverlay = document.getElementById('pauseOverlay');

    if (isPaused) {
        clearInterval(timerInterval);
        pauseBtn.innerHTML = '&#9658; Riprendi';
        pauseBtn.classList.add('paused');
        pauseOverlay.classList.remove('hidden');
    } else {
        startTimer();
        pauseBtn.innerHTML = '&#10074;&#10074; Pausa';
        pauseBtn.classList.remove('paused');
        pauseOverlay.classList.add('hidden');
    }
}

function renderQuestion() {
    const q = questions[currentQuestion];
    const container = document.getElementById('questionsContainer');

    let typeClass = q.type;

    container.innerHTML = `
        <div class="question-card current">
            <div class="question-header">
                <span class="question-number">Domanda ${q.id}</span>
                <span class="question-type ${typeClass}">${q.typeLabel}</span>
            </div>
            <div class="question-text">${q.text}</div>
            <div class="options-list">
                ${q.options.map((opt, idx) => `
                    <div class="option ${userAnswers[currentQuestion] === idx ? 'selected' : ''}"
                         onclick="selectAnswer(${idx})">
                        <span class="option-letter">${String.fromCharCode(65 + idx)})</span>
                        <span class="option-text">${opt}</span>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    updateStats();
    updateExplanationPanel();
}

function updateExplanationPanel() {
    const q = questions[currentQuestion];
    const container = document.getElementById('explanationContent');
    const hasAnswer = userAnswers[currentQuestion] !== null;

    if (!hasAnswer) {
        container.innerHTML = '<p class="no-answer">Seleziona una risposta per vedere la spiegazione</p>';
        return;
    }

    const correctLetter = String.fromCharCode(65 + q.correct);
    const correctText = q.options[q.correct];

    container.innerHTML = `
        <div class="explanation-content">
            <div class="correct-answer-box">
                <div class="label">Risposta corretta</div>
                <div class="answer">${correctLetter}) ${correctText}</div>
            </div>
            ${q.explanation ? `<p>${q.explanation}</p>` : '<p>Nessuna spiegazione disponibile.</p>'}
        </div>
    `;
}

function selectAnswer(index) {
    userAnswers[currentQuestion] = index;
    renderQuestion();
}

function goToQuestion(index) {
    currentQuestion = index;
    renderQuestion();
}

function previousQuestion() {
    if (currentQuestion > 0) {
        currentQuestion--;
        renderQuestion();
    }
}

function nextQuestion() {
    if (currentQuestion < questions.length - 1) {
        currentQuestion++;
        renderQuestion();
    }
}

function updateStats() {
    const answered = userAnswers.filter(a => a !== null).length;
    const skipped = questions.length - answered;
    const progress = Math.round((answered / questions.length) * 100);

    document.getElementById('answeredCount').textContent = `${answered}/${questions.length}`;
    document.getElementById('skippedCount').textContent = skipped;
    document.getElementById('progressText').textContent = `${progress}%`;
    document.getElementById('progressFill').style.width = `${progress}%`;
}

function submitExam() {
    if (timerInterval) clearInterval(timerInterval);
    examEndTime = new Date();

    const confirmSubmit = timeRemaining > 0 ?
        confirm('Sei sicuro di voler consegnare l\'esame?') : true;

    if (!confirmSubmit) {
        startTimer();
        return;
    }

    calculateResults();
}

function calculateResults() {
    let correct = 0;
    let wrong = 0;
    let notAnswered = 0;
    let totalScore = 0;

    // Category stats
    const categoryStats = {
        comune: { correct: 0, wrong: 0, total: 0, label: 'Quesiti Comuni', topics: [] },
        specifico: { correct: 0, wrong: 0, total: 0, label: 'Quesiti Specifici', topics: [] },
        logica: { correct: 0, wrong: 0, total: 0, label: 'Quesiti Logica', topics: [] },
        situazionale: { correct: 0, wrong: 0, total: 0, label: 'Quesiti Situazionali', topics: [] }
    };

    questions.forEach((q, index) => {
        const answer = userAnswers[index];
        const cat = categoryStats[q.type];
        cat.total++;

        if (answer === null) {
            notAnswered++;
            cat.wrong++;
            cat.topics.push({ label: q.typeLabel, wrong: true });
        } else if (q.type === 'situazionale') {
            totalScore += q.scoring[answer];
            if (answer === q.correct) {
                correct++;
                cat.correct++;
            } else if (q.scoring[answer] === 0) {
                wrong++;
                cat.wrong++;
                cat.topics.push({ label: q.typeLabel, wrong: true });
            }
        } else {
            if (answer === q.correct) {
                correct++;
                cat.correct++;
                totalScore += 0.75;
            } else {
                wrong++;
                cat.wrong++;
                cat.topics.push({ label: q.typeLabel, wrong: true });
                totalScore -= 0.25;
            }
        }
    });

    totalScore = Math.round(totalScore * 100) / 100;
    if (totalScore < 0) totalScore = 0;

    const timeUsed = Math.round((examEndTime - examStartTime) / 1000);
    const minutesUsed = Math.floor(timeUsed / 60);
    const secondsUsed = timeUsed % 60;

    // Show results screen
    document.getElementById('examScreen').classList.add('hidden');
    document.getElementById('resultsScreen').classList.add('show');

    const passed = totalScore >= 21;

    // Animate circular score
    const scoreCircle = document.getElementById('scoreCircle');
    const circumference = 264;
    const scorePercent = Math.min(totalScore / 30, 1);
    const offset = circumference - (scorePercent * circumference);

    scoreCircle.classList.remove('passed', 'failed');
    scoreCircle.classList.add(passed ? 'passed' : 'failed');
    setTimeout(() => {
        scoreCircle.style.strokeDashoffset = offset;
    }, 100);

    document.getElementById('finalScore').textContent = totalScore;
    document.getElementById('examStatus').textContent = passed ? 'IDONEO' : 'NON IDONEO';
    document.getElementById('examStatus').className = `results-status ${passed ? 'passed' : 'failed'}`;

    document.getElementById('correctCount').textContent = correct;
    document.getElementById('wrongCount').textContent = wrong;
    document.getElementById('notAnsweredCount').textContent = notAnswered;
    document.getElementById('timeUsed').textContent = `${minutesUsed}:${secondsUsed.toString().padStart(2, '0')}`;

    renderCategoryBreakdown(categoryStats);
    renderRecommendations(categoryStats);
    renderReview();
}

function renderCategoryBreakdown(stats) {
    const container = document.getElementById('categoryBreakdown');
    container.innerHTML = '';

    const categories = [
        { key: 'comune', icon: '&#128214;' },
        { key: 'specifico', icon: '&#128188;' },
        { key: 'logica', icon: '&#129504;' },
        { key: 'situazionale', icon: '&#128101;' }
    ];

    categories.forEach(cat => {
        const s = stats[cat.key];
        const percent = s.total > 0 ? Math.round((s.correct / s.total) * 100) : 0;
        let fillClass = 'poor';
        if (percent >= 80) fillClass = 'excellent';
        else if (percent >= 60) fillClass = 'good';
        else if (percent >= 40) fillClass = 'medium';

        container.innerHTML += `
            <div class="category-item">
                <div class="category-header">
                    <span class="category-name">${cat.icon} ${s.label}</span>
                    <span class="category-score">${s.correct}/${s.total} (${percent}%)</span>
                </div>
                <div class="category-bar">
                    <div class="category-fill ${fillClass}" style="width: ${percent}%"></div>
                </div>
            </div>
        `;
    });
}

function renderRecommendations(stats) {
    const container = document.getElementById('recommendationsContainer');
    container.innerHTML = '';

    const recommendations = [];

    // Analyze each category
    const catInfo = {
        comune: {
            label: 'Diritto Amministrativo e Normativa',
            desc: 'Ripassare L. 241/1990, D.Lgs. 33/2013, CAD e diritto penale della PA.',
            link: 'https://fracabu.github.io/guida-mic/#materie'
        },
        specifico: {
            label: 'Contabilita\' e Diritto UE',
            desc: 'Approfondire L. 196/2009, D.Lgs. 165/2001 e istituzioni europee.',
            link: 'https://fracabu.github.io/guida-mic/#materie'
        },
        logica: {
            label: 'Ragionamento Logico',
            desc: 'Esercitarsi con serie numeriche, analogie verbali e sillogismi.',
            link: 'https://fracabu.github.io/guida-mic/#banche-dati'
        },
        situazionale: {
            label: 'Quesiti Situazionali',
            desc: 'Rivedere il codice di comportamento e le soft skills richieste.',
            link: 'https://fracabu.github.io/guida-mic/#consigli'
        }
    };

    Object.keys(stats).forEach(key => {
        const s = stats[key];
        const percent = s.total > 0 ? Math.round((s.correct / s.total) * 100) : 0;
        const info = catInfo[key];

        if (percent < 50) {
            recommendations.push({
                type: 'critical',
                icon: '&#9888;',
                title: `Attenzione: ${info.label}`,
                desc: `Hai risposto correttamente solo al ${percent}% dei quesiti. ${info.desc}`,
                link: info.link
            });
        } else if (percent < 70) {
            recommendations.push({
                type: 'warning',
                icon: '&#128161;',
                title: `Da migliorare: ${info.label}`,
                desc: `${percent}% di risposte corrette. Continua a studiare per consolidare. ${info.desc}`,
                link: info.link
            });
        }
    });

    // Add success message if doing well
    const totalCorrect = Object.values(stats).reduce((sum, s) => sum + s.correct, 0);
    const totalQuestions = Object.values(stats).reduce((sum, s) => sum + s.total, 0);
    const overallPercent = Math.round((totalCorrect / totalQuestions) * 100);

    if (overallPercent >= 70) {
        recommendations.unshift({
            type: 'success',
            icon: '&#127942;',
            title: 'Ottimo lavoro!',
            desc: `Hai risposto correttamente al ${overallPercent}% delle domande. Continua cosi\' per consolidare la preparazione.`,
            link: null
        });
    }

    if (recommendations.length === 0) {
        recommendations.push({
            type: 'warning',
            icon: '&#128218;',
            title: 'Continua a studiare',
            desc: 'Rivedi tutte le materie per migliorare il tuo punteggio.',
            link: 'https://fracabu.github.io/guida-mic/'
        });
    }

    recommendations.forEach(rec => {
        container.innerHTML += `
            <div class="rec-item ${rec.type}">
                <div class="rec-icon">${rec.icon}</div>
                <div class="rec-text">
                    <h4>${rec.title}</h4>
                    <p>${rec.desc}</p>
                    ${rec.link ? `<a href="${rec.link}" target="_blank" class="rec-link">Vai ai materiali &#8594;</a>` : ''}
                </div>
            </div>
        `;
    });
}

function toggleSection(section) {
    const content = document.getElementById(section + 'Content');
    const toggle = document.getElementById(section + 'Toggle');

    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.textContent = 'Mostra';
    } else {
        content.classList.add('show');
        toggle.textContent = 'Nascondi';
    }
}

function downloadPDF() {
    const now = new Date();
    const dateStr = now.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const timeStr = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });

    const score = document.getElementById('finalScore').textContent;
    const status = document.getElementById('examStatus').textContent;
    const correct = document.getElementById('correctCount').textContent;
    const wrong = document.getElementById('wrongCount').textContent;
    const skipped = document.getElementById('notAnsweredCount').textContent;
    const timeUsed = document.getElementById('timeUsed').textContent;

    const categories = document.querySelectorAll('#categoryBreakdown .category-item');
    let categoryHTML = '';
    categories.forEach(cat => {
        const name = cat.querySelector('.category-name').textContent;
        const catScore = cat.querySelector('.category-score').textContent;
        categoryHTML += `<tr><td style="padding: 8px; border: 1px solid #e2e8f0;">${name}</td><td style="padding: 8px; border: 1px solid #e2e8f0; text-align: center;">${catScore}</td></tr>`;
    });

    let questionsHTML = '';
    questions.forEach((q, index) => {
        const answer = userAnswers[index];
        const isCorrect = answer === q.correct;
        const isSkipped = answer === null;
        const statusText = isSkipped ? 'Saltata' : (isCorrect ? 'Corretta' : 'Errata');
        const statusColor = isSkipped ? '#94a3b8' : (isCorrect ? '#10b981' : '#ef4444');
        const userAnswer = answer !== null ? String.fromCharCode(65 + answer) : '-';
        const correctAnswer = String.fromCharCode(65 + q.correct);

        questionsHTML += `
            <div style="margin-bottom: 15px; padding: 12px; border-left: 4px solid ${statusColor}; background: #f8fafc; border-radius: 8px; page-break-inside: avoid;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 8px; flex-wrap: wrap; gap: 5px;">
                    <span style="background: #4f46e5; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px; font-weight: 600;">D${q.id}</span>
                    <span style="background: #e2e8f0; padding: 3px 8px; border-radius: 8px; font-size: 11px;">${q.typeLabel}</span>
                    <span style="color: ${statusColor}; font-weight: 600; font-size: 12px;">${statusText}</span>
                </div>
                <p style="font-size: 13px; margin-bottom: 8px; line-height: 1.5;">${q.text}</p>
                <div style="font-size: 12px; color: #475569;">
                    <span style="margin-right: 15px;">Tua risposta: <strong>${userAnswer}</strong></span>
                    <span>Risposta corretta: <strong style="color: #10b981;">${correctAnswer}</strong></span>
                </div>
            </div>
        `;
    });

    const pdfContent = `
        <div id="pdfContent" style="font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; color: #1e293b;">
            <div style="background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; margin-bottom: 25px;">
                <h1 style="margin: 0 0 5px 0; font-size: 22px;">CONCORSO MIC</h1>
                <h2 style="margin: 0; font-size: 14px; opacity: 0.9;">Simulazione Prova Scritta</h2>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 13px; color: #64748b;">
                <span>Data: ${dateStr}</span>
                <span>Ora: ${timeStr}</span>
            </div>
            <div style="background: #f8fafc; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #4f46e5;">Riepilogo Risultati</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 28px; font-weight: 700; color: ${status === 'IDONEO' ? '#10b981' : '#ef4444'};">${score}</div>
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Punteggio / 30</div>
                        <div style="margin-top: 5px; font-size: 12px; font-weight: 600; color: ${status === 'IDONEO' ? '#10b981' : '#ef4444'};">${status}</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 28px; font-weight: 700; color: #10b981;">${correct}</div>
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Corrette</div>
                    </div>
                    <div style="background: white; padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <div style="font-size: 28px; font-weight: 700; color: #ef4444;">${wrong}</div>
                        <div style="font-size: 11px; color: #64748b; text-transform: uppercase;">Errate</div>
                    </div>
                </div>
                <div style="display: flex; justify-content: center; gap: 30px; margin-top: 15px; font-size: 13px;">
                    <span>Saltate: <strong>${skipped}</strong></span>
                    <span>Tempo: <strong>${timeUsed}</strong></span>
                </div>
            </div>
            <div style="margin-bottom: 25px;">
                <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #4f46e5;">Analisi per Categoria</h3>
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                    <thead>
                        <tr style="background: #f1f5f9;">
                            <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: left;">Categoria</th>
                            <th style="padding: 10px; border: 1px solid #e2e8f0; text-align: center;">Risultato</th>
                        </tr>
                    </thead>
                    <tbody>${categoryHTML}</tbody>
                </table>
            </div>
            <div>
                <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #4f46e5;">Dettaglio Risposte</h3>
                ${questionsHTML}
            </div>
            <div style="margin-top: 30px; padding-top: 15px; border-top: 1px solid #e2e8f0; text-align: center; font-size: 11px; color: #94a3b8;">
                MIC STUDIO - Simulatore basato sul Bando Ufficiale
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = pdfContent;
    document.body.appendChild(tempDiv);

    const element = tempDiv.querySelector('#pdfContent');
    const opt = {
        margin: 10,
        filename: `MIC_Risultati_${dateStr.replace(/\//g, '-')}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
    };

    html2pdf().set(opt).from(element).save().then(() => {
        document.body.removeChild(tempDiv);
    });
}

function renderReview() {
    const container = document.getElementById('reviewContainer');
    container.innerHTML = '';

    questions.forEach((q, index) => {
        const answer = userAnswers[index];
        const isCorrect = answer === q.correct;
        const isSkipped = answer === null;

        const statusClass = isSkipped ? 'skipped' : (isCorrect ? 'correct' : 'wrong');
        const statusText = isSkipped ? 'Saltata' : (isCorrect ? 'Corretta' : 'Errata');

        container.innerHTML += `
            <div class="review-question ${statusClass}">
                <div class="review-question-header">
                    <span class="review-question-num">D${q.id}</span>
                    <span class="review-question-type">${q.typeLabel}</span>
                    <span class="review-question-status ${statusClass}">${statusText}</span>
                </div>
                <div class="review-question-text">${q.text}</div>
                <div class="review-options">
                    ${q.options.map((opt, idx) => {
                        let optClass = 'review-option';
                        if (idx === q.correct) optClass += ' correct-answer';
                        else if (idx === answer && idx !== q.correct) optClass += ' wrong-answer';

                        return `
                            <div class="${optClass}">
                                <span class="review-option-letter">${String.fromCharCode(65 + idx)})</span>
                                <span>${opt}</span>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    });
}

function restartExam() {
    // Reset state
    currentQuestion = 0;
    userAnswers = new Array(questions.length).fill(null);
    timeRemaining = 60 * 60;
    examStartTime = null;
    examEndTime = null;

    // Reset UI
    document.getElementById('resultsScreen').classList.remove('show');
    document.getElementById('timerBox').classList.remove('warning');
    document.getElementById('startScreen').classList.remove('hidden');
    document.getElementById('mainContainer').classList.remove('exam-mode');
    document.getElementById('mainContainer').classList.add('start-mode');
}

// ==================== THEME TOGGLE ====================
function toggleTheme() {
    const html = document.documentElement;
    const btn = document.getElementById('themeToggle');

    if (html.getAttribute('data-theme') === 'dark') {
        html.removeAttribute('data-theme');
        btn.innerHTML = '&#9790; Dark';
        localStorage.setItem('theme', 'light');
    } else {
        html.setAttribute('data-theme', 'dark');
        btn.innerHTML = '&#9788; Light';
        localStorage.setItem('theme', 'dark');
    }
}

// Load saved theme on page load
(function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').innerHTML = '&#9788; Light';
    }
})();
</script>

</body>
</html>
